<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | KwikChat</title>
    <style>
@import url("https://fonts.googleapis.com/css?family=Manrope:300,400,500,600,700&display=swap&subset=latin-ext");

:root {
--card-shadow:5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.7);
--card--theme:#d8f2ff;
--recents-bg: #e5ecef;
--receivers-chat:#f1f1f1;
--black-white:#000000;
--txt-clr:#000;
--grey-clr:#a2a2a2;
 --body-bg-color: #e5ecef;
 --theme-bg-color: #ecfffe;
 --settings-icon-hover: #9fa7ac;
 --developer-color: #f9fafb;
 --input-bg: #f8f8fa;
 --input-chat-color: #a2a2a2;
 --border-color: #eef2f4;
 --body-font: "Manrope", sans-serif;
 --body-color: #273346;
 --settings-icon-color: #c1c7cd;
 --msg-message: #969eaa;
 --chat-text-bg: #f1f2f6;
 --theme-color: #144890;
 --msg-date: #c0c7d2;
 --button-bg-color: #f0f7ff;
 --button-color: var(--theme-color);
 --detail-font-color: #919ca2;
 --msg-hover-bg: rgba(238, 242, 244, 0.4);
 --active-conversation-bg: linear-gradient(
  to right,
  rgba(238, 242, 244, 0.4) 0%,
  rgba(238, 242, 244, 0) 100%
 );
 --overlay-bg: linear-gradient(
  to bottom,
  rgba(255, 255, 255, 0) 0%,
  rgba(255, 255, 255, 1) 65%,
  rgba(255, 255, 255, 1) 100%
 );
 --chat-header-bg: linear-gradient(
  to bottom,
  rgba(255, 255, 255, 1) 0%,
  rgba(255, 255, 255, 1) 78%,
  rgba(255, 255, 255, 0) 100%
 );
}

[data-theme="purple"] {
 --theme-color: #8357dc;
 --button-color:  #8357dc;
 --button-bg-color: rgba(159, 122, 234, 0.12);
}

[data-theme="green"] {
 --theme-color: #149086;
 --button-color: #149086;
 --button-bg-color: rgba(56, 178, 171, 0.15);
}

[data-theme="orange"] {
 --theme-color: #a65621;
 --button-color: #a65621;
 --button-bg-color: rgba(237, 137, 54, 0.12);
}

.dark-mode {
--card-shadow:5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(0, 0, 0, 0);
--card--theme:#161f24;
--recents-bg:  #27292d;
--receivers-chat:#9e9ea1;
--black-white:#ffffff;
--txt-clr:#fff;
--grey-clr:#6f7073;
 --body-bg-color: #1d1d1d;
 --theme-bg-color: #27292d;
 --border-color: #323336;
 --body-color: #d1d1d2;
 --active-conversation-bg: linear-gradient(
  to right,
  rgba(47, 50, 56, 0.54),
  rgba(238, 242, 244, 0) 100%
 );
 --msg-hover-bg: rgba(47, 50, 56, 0.54);
 --chat-text-bg: #383b40;
 --chat-text-color: #b5b7ba;
 --msg-date: #626466;
 --msg-message: var(--msg-date);
 --overlay-bg: linear-gradient(
  to bottom,
  rgba(0, 0, 0, 0) 0%,
  #27292d 65%,
  #27292d 100%
 );
 --input-bg: #2f3236;
 --chat-header-bg: linear-gradient(
  to bottom,
  #27292d 0%,
  #27292d 78%,
  rgba(255, 255, 255, 0) 100%
 );
 --settings-icon-color: #7c7e80;
 --developer-color: var(--border-color);
 --button-bg-color: #393b40;
 --button-color: var(--body-color);
 --input-chat-color: #6f7073;
 --detail-font-color: var(--input-chat-color);
}

.blue {
 background-color: #0086ff;
}

.purple {
 background-color: #9f7aea;
}

.green {
 background-color: #38b2ac;
}

.orange {
 background-color: #ed8936;
}

* 
{
 outline: none;
 box-sizing: border-box;
}

body
{
    background-color:  var(--theme-bg-color);
    font-family: var(--body-font);
    color: var(--body-color);
    overflow-y: hidden;
}
html {
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
}
   
.header 
{
    height: 80px;
    width: 100%;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    padding: 0 20px;
}
.logo {
    color: var(--theme-color);
    width: 38px;
    flex-shrink: 0;
    img {
     width: 45px;
     height:30px;
    }
}
.user-settings 
{
display: flex;
align-items: center;
cursor: pointer;
margin-left: auto;
flex-shrink: 0;
& > * + * {
    margin-left: 14px;
}
}

.dark-light 
{
width: 22px;
height: 22px;
color: var(--settings-icon-color);
flex-shrink: 0;

svg 
{
    width: 100%;
    fill: transparent;
    transition: 0.5s;
}
}

.user-profile 
{
width: 40px;
height: 40px;
border-radius: 50%;
}

.settings 
{
color: var(--settings-icon-color);
width: 22px;
height: 22px;
flex-shrink: 0;
display: inline-block;
position: relative;
cursor: pointer;
}  
.settingsdown {
    position: absolute;
    top: 40px; /* Adjust to position below the icon */
    right: 0;
    background: var(--input-bg); /* Adjust to your theme */
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 8px 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    display: none; /* Initially hidden */
}

.settingsdown button {
    background: none;
    border: none;
    color: var(--body-color);
    font-size: 16px;
    cursor: pointer;
    padding: 8px 12px;
    width: 100%;
}


.user-profile-pic
{
    width: 200px;
    height: 200px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgb(6, 84, 136);
    position: relative;
}
.card {
  background: var(--card--theme);
  width: 500px;
  height: 500px;
  border: 2px solid var(--main-color);
  box-shadow: 4px 4px var(--main-color);
  border-radius: 5px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: max-content;
  padding:20px;
  margin-top: 10vh;
  box-shadow: var(--card-shadow);
}


.card-title {
  text-align: center;
  color: var(--font-color);
  font-size: 20px;
  font-weight: 400;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

.card-title span {
  font-size: 30px;
  font-weight: 600;
  color: var(--font-color-sub);
}

.profile-customize
{
    display: flex;
    justify-content: center;
    align-items: center;
    width:100%;
    margin-top: 100px;
    height:400px;
}
.edit
{
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    width:600px;
}
#profilePicInput 
{
        display: none;
}

/* Style the label as an icon button */
.custom-file-upload {
    display: inline-block;
    font-size: 18px;
    cursor: pointer;
    border-radius: 50%;
    rotate: 270deg;
    position: absolute;
    margin-left: 130px;
    background-color: rgb(248, 248, 248);
    width:25px;
    height:25px;
}

.custom-file-upload:hover {
    color: #45a049;
}
.profile-pic-wrapper
{
    display: flex;
    width:max-content;
    left:0;
    align-items: flex-end;
    position: relative;
}
#newUsername
{
    width:150px;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--grey-clr);
    color:var(--black-white);
    font-size: 16px;
}
#newUsername:focus::placeholder
{
    color: transparent;
    transition: 0.5s ease;
}
.card h3
{
    color: rgb(75, 138, 255);
}
.card h4
{
    color:var(--black-white)
}
#updateUsername
{
    color:white;
    background: none;
    border:none;
    padding:10px 15px;
    background-color: rgb(56, 46, 255);
    border-radius: 10px;
    font-weight: 700;
    margin-left: 10px;
    transition: 0.5s ease;
    cursor: pointer;
}
#updateUsername:hover
{
    background-color: rgb(42, 70, 255);
}
#uploadProfilePic
{
    margin-top: 20px;
    background-color: rgb(2, 114, 2);
    padding:8px 20px;
    border:none;
    color: white;
    font-weight: bolder;
    transition: 0.5s ease;
    cursor: pointer;
}
#uploadProfilePic:hover
{
    background-color:rgb(4, 153, 4);
}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">+
            <a href="/"><img src="/static/KwikChat_logo.png" alt="KwikChat_logo"></a>
        </div>
        <div class="user-settings">
        <div class="dark-light">
            <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" /></svg>
        </div>
        <div class="settings">
            <svg id="settings-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3" />
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
            </svg>
            <div id="settings-menu" class="seytttingsdown" style="display: none;">
                <button id="logout-button" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <a href="/profile"><img class="user-profile" src="{{ url_for('get_profile_picture', user_id=current_user.id) }}"></a>
        </div>
    </div>
    <center><p>Please click 'Save' to apply your changes before you leave.</p></center>
<div class="profile-customize">
<div class="edit">
<div class="card">
    <h3>Customize Profile</h3>
    <div class="card-photo">        
        <div class="profile-pic-wrapper">
            <img id="profilePicPreview" class="user-profile-pic" src="{{ url_for('get_profile_picture', user_id=current_user.id) }}">
            <label for="profilePicInput" class="custom-file-upload">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="blue">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0L15 3.25l3.75 3.75 1.96-1.96z"/>
                </svg>
            </label>
            <input type="file"  id="profilePicInput" accept="image/*">
        </div>
    </div>
    <div class="card-title"><h2><span id="currentUsername">Loading...</span></h2></div>
<div class="profile-container">
        <h5>Change Username</h5>
        <input type="text" id="newUsername" placeholder="Enter new username">
        <button id="updateUsername">Update</button><br>
        <button id="uploadProfilePic">Save</button>
</div>
</div>
</div>
</div>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const profilePicInput = document.getElementById("profilePicInput");
            const profilePicPreview = document.getElementById("profilePicPreview");
            const uploadButton = document.getElementById("uploadProfilePic");

            // Preview Image Before Upload
            profilePicInput.addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        profilePicPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Upload Profile Picture
            uploadButton.addEventListener("click", async function () {
                const file = profilePicInput.files[0];

                if (!file) {
                    alert("Please select an image first.");
                    return;
                }

                const formData = new FormData();
                formData.append("profile_pic", file);

                try {
                    const response = await fetch("/update-profile-picture", {
                        method: "POST",
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert("Profile picture updated successfully!");
                    } else {
                        alert("Error: " + data.message);
                    }
                } catch (error) {
                    console.error("Upload failed:", error);
                }
            });
        });

///////////CURRENT_USERNAME///////////////////
document.addEventListener("DOMContentLoaded", () => {
        const usernameInput = document.getElementById("newUsername");
        const updateUsernameBtn = document.getElementById("updateUsername");
        const currentUsernameSpan = document.getElementById("currentUsername");

        // Fetch the current username when the page loads
        async function fetchCurrentUser() {
            try {
                const response = await fetch("/api/get_current_user");
                const data = await response.json();

                if (data.username) {
                    currentUsernameSpan.textContent = data.username;
                } else {
                    currentUsernameSpan.textContent = "Unknown";
                }
            } catch (error) {
                console.error("Error fetching current user:", error);
            }
        }

        // Update username
        updateUsernameBtn.addEventListener("click", async function () {
            const newUsername = usernameInput.value.trim();

            if (!newUsername) {
                alert("Please enter a valid username.");
                return;
            }

            try {
                const response = await fetch("/update-username", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ new_username: newUsername }),
                });

                const data = await response.json();
                if (data.success) {
                    alert("Username updated successfully!");
                    currentUsernameSpan.textContent = newUsername; // Update displayed username
                } else {
                    alert("Error: " + data.message);
                }
            } catch (error) {
                console.error("Update failed:", error);
            }
        });

        fetchCurrentUser(); // Load current username on page load
    });

    const toggleButton = document.querySelector('.dark-light');
const colors = document.querySelectorAll('.color');

// Load saved theme from localStorage
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('themeColor');
    if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
        
        // Remove 'selected' from all and apply only to the saved theme
        colors.forEach(color => {
            color.classList.remove('selected'); 
            if (color.getAttribute('data-color') === savedTheme) {
                color.classList.add('selected'); // Only select the saved theme
            }
        });
    }

    const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
    }
});


// Event listener for theme selection
colors.forEach(color => {
    color.addEventListener('click', () => {
        // Remove 'selected' from all before adding it to the clicked one
        colors.forEach(c => c.classList.remove('selected'));

        const theme = color.getAttribute('data-color');
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('themeColor', theme); // Save theme in localStorage
        
        color.classList.add('selected'); // Add 'selected' to clicked color
    });
});

// Event listener for dark/light mode toggle
toggleButton.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled'); // Store dark mode preference
});
///////////////////////////////////////////////////////////////////////////////////////////////////Settings Toggle////////////////////////////

document.addEventListener("DOMContentLoaded", function () {
    const settingsIcon = document.getElementById("settings-icon");
    const settingsMenu = document.getElementById("settings-menu");
    const logoutButton = document.getElementById("logout-button");

    // Toggle dropdown visibility
    settingsIcon.addEventListener("click", function (event) {
        event.stopPropagation(); // Prevents closing when clicking the icon
        const isVisible = settingsMenu.style.display === "block";

        settingsMenu.style.display = isVisible ? "none" : "block";
        logoutButton.style.display = isVisible ? "none" : "block"; // Show/hide logout button
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
        if (!settingsIcon.contains(event.target) && !settingsMenu.contains(event.target)) {
            settingsMenu.style.display = "none";
            logoutButton.style.display = "none"; // Hide logout button
        }
    });
});

    </script>
</body>
</html>
